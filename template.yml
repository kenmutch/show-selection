AWSTemplateFormatVersion: 2010-09-09
Transform:
- AWS::Serverless-2016-10-31
- AWS::CodeStar

Parameters:
  ProjectId:
    Type: String
    Description: AWS CodeStar projectID used to associate new resources to team members

Resources:
  ShowSelectionsApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      DefinitionBody:
        swagger: '2.0'
        info:
          title: Show Selection API
          version: '1.0.0'
        schemes:
          - https
        paths:
          /selected-shows:
            get:
              responses:
                '200':
                  description: 200 response
              security: 
                - CatchupCatchaUserPool: ["com.catchup-catcha/shows.selected"]
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: '200'
                uri: 
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ShowSelectionService.Arn}/invocations
                passthroughBehavior: when_no_match
                httpMethod: POST
                type: aws
            post:
              summary: Select a show
              consumes:
                - application/json
              parameters:
                - in: body
                  name: showId
                  description: The id of the show selected.
                  schema:
                    type: string
              responses:
                '204':
                  description: 204 response
              security: 
                - CatchupCatchaUserPool: ["com.catchup-catcha/shows.selected"]
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: '204'
                uri: 
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ShowSelectionService.Arn}/invocations
                passthroughBehavior: when_no_match
                httpMethod: POST
                type: aws
          /selected-shows/{showId}:
            delete:
              parameters:
                - name: showId
                  in: path
                  required: true
                  type: string
              responses:
                '200':
                  description: 200 response
              security: 
                - CatchupCatchaUserPool: ["com.catchup-catcha/shows.selected"]
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: '200'
                requestParameters:
                  integration.request.path.id: method.request.path.showId
                uri: 
                  Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ShowSelectionService.Arn}/invocations
                passthroughBehavior: when_no_match
                httpMethod: POST
                type: aws
        securityDefinitions:
          CatchupCatchaUserPool:
            type: apiKey
            name: Authorization
            in: header
            x-amazon-apigateway-authtype: cognito_user_pools
            x-amazon-apigateway-authorizer:
              type: cognito_user_pools
              providerARNs:
              - arn:aws:cognito-idp:ap-southeast-2:828944938596:userpool/ap-southeast-2_JS1CQbCvb
  ShowSelectionService:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/index.handler
      Runtime: nodejs8.10
      Environment:
        Variables:
          NODE_ENV: production
          TABLE_NAME: !Ref ShowSelectionsTable
      Role:
        Fn::ImportValue:
          !Join ['-', [!Ref 'ProjectId', !Ref 'AWS::Region', 'LambdaTrustRole']]
      Events:
        GetEvent:
          Type: Api
          Properties:
            Path: /selected-shows
            Method: get
            RestApiId: 
              Ref: ShowSelectionsApi
        PostEvent:
          Type: Api
          Properties:
            Path: /selected-shows
            Method: post
            RestApiId: !
              Ref: ShowSelectionsApi
        DeleteEvent:
          Type: Api
          Properties:
            Path: /selected-shows/{id}
            Method: delete
            RestApiId: 
              Ref: ShowSelectionsApi
  ShowSelectionsTable:
    Type: AWS::DynamoDB::Table
    Properties: 
      AttributeDefinitions: 
        - AttributeName: id
          AttributeType: S
        - AttributeName: username
          AttributeType: S
      KeySchema: 
        - AttributeName: id
          KeyType: HASH
        - AttributeName: username
          KeyType: RANGE
      ProvisionedThroughput: 
        ReadCapacityUnits: 5
        WriteCapacityUnits: 1
